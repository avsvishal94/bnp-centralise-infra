# SRE Ecosystem – Centrally Managed Terraform Infrastructure Pipeline

## Flow Document

---

## 1. Overview

This document describes the end-to-end architecture for the SRE Ecosystem — a centrally managed Terraform infrastructure pipeline. The architecture is organized into three layers: the **SRE Managed Layer** (centrally owned), the **Application Team Layer** (consumer), and the **Infrastructure Layer** (resources provisioned). Jenkins CI/CD orchestrates Terraform IaC execution through dedicated agents, with all credentials managed via CyberArk and state files stored in Artifactory.

---

## 2. Architecture Layers

### 2.1 SRE Managed Layer (Centrally Owned)

This layer contains all components owned and maintained by the SRE team. Application teams consume these components but do not modify them.

#### Terraform Module Registry (Artifactory)

The module registry is hosted in Artifactory and contains:
- **Versioned TF Modules** — Reusable modules for vSphere VMs, HAProxy load balancers, NSX-T firewalls, and NFS servers (`terraform-modules/modules/`)
- **Marketplace Inventory** — VM templates available for provisioning
- **Service Catalog** — Approved infrastructure patterns and configurations

Modules are stored in `terraform-modules/modules/` with the following structure:
- `vsphere-vm/` — Base VM provisioning module
- `haproxy-lb/` — HAProxy load balancer (wraps vsphere-vm)
- `nsx-firewall/` — NSX-T firewall security policies
- `nfs-server/` — NFS storage server (wraps vsphere-vm)

#### Jenkins Shared Library (jenkins-devops-cicd-library)

The shared library (`jenkins-shared-library/`) provides reusable pipeline steps:
- **Pipeline Templates** — Jenkinsfile.template with 6-stage pipeline
- **Reusable Steps** — `terraformInit`, `terraformValidate`, `terraformPlan`, `terraformApply`, `terraformDestroy`, `postDeployValidation`, `approvalGate`, `artifactoryModuleFetch`
- **CyberArk Integration** — `cyberarkCredentials` helper for certificate injection
- **Credential Helpers** — Wrappers for Artifactory and Apigee credential loading

#### Terraform State Management (Artifactory Remote Backend)

State files are stored in Artifactory with per-application, per-environment isolation:
```
terraform-statefiles/
└── <app-name>/
    ├── dev/
    ├── stg/
    ├── pt/
    └── qa/
```
State locking prevents concurrent modifications.

#### Jenkinsfile Template Generator

The `Jenkinsfile.template` generates per-application Jenkinsfiles with:
- Environment parameters (DEV, STG, PT, QA)
- Ecosystem parameters (PB-GLOBALPRIMEDB, Puma)
- CyberArk certificate configuration
- Artifactory credential IDs

#### Credential Store (Jenkins + CyberArk)

All sensitive credentials are managed centrally:
- **CyberArk Certs** — TLS certificates for API authentication
- **CA Bundle** — Certificate authority chain
- **Artifactory Tokens** — Service account credentials for state and module access
- **API Keys** — Apigee and other service API keys

#### SRE Onboarding Script

The `sre_onboard_app.sh` script automates application onboarding:
1. Creates statefile directories in Artifactory
2. Generates Jenkinsfile from template with app-specific values
3. Copies sample Terraform files for the application team
4. Optionally pushes generated files to the application repository

#### Terraform Agent (Provisioned from Marketplace)

Dedicated Jenkins agents provisioned via `terraform-agent/setup-agent.sh`:
- Terraform installation and configuration
- Java installation (Jenkins agent requirement)
- Ansible and jq installation
- SSH-based Jenkins agent configuration
- Agent labeled as `terraform-agent` for pipeline targeting
- Artifactory provider mirror configured in `~/.terraformrc`

---

### 2.2 Application Team Layer (Consumer)

#### Application Repo (Bitbucket)

Each application repository contains:
- **Jenkinsfile** — Auto-generated by SRE onboarding (references shared library)
- **Terraform .tf files** — Infrastructure definitions authored by the app team
  - `backend.tf` — Artifactory remote backend configuration
  - `variables.tf` — Pipeline-injected and user-defined variables
  - `main.tf` — Infrastructure resource definitions using SRE modules
  - `outputs.tf` — Output values captured by the pipeline

Sample Terraform files are provided in `sample-app-terraform/` for bootstrapping.

#### Jenkins Pipeline (bnpp-cdtools-amer)

The pipeline accepts build parameters:
- **ENVIRONMENT** — DEV, STG, PT, QA
- **ECOSYSTEM** — PB-GLOBALPRIMEDB, Puma
- **ACTION** — apply or destroy
- **AUTO_APPROVE** — Skip manual approval gate
- **TARGET_BRANCH** — Branch to checkout

#### Terraform Execution Stages

The 6-stage pipeline executes:
1. **Clone Repo** — Checkout code, fetch modules from Artifactory
2. **TF Init** — Initialize backend, download providers, init modules
3. **TF Plan** — Generate and archive execution plan
4. **Approval** — Manual gate with ServiceNow integration
5. **TF Apply** — Execute plan, capture outputs, update state
6. **TF Destroy** — (Conditional) Destroy infrastructure with confirmation

---

### 2.3 Infrastructure Layer (Resources Provisioned)

#### Target Environments

Infrastructure is provisioned across four isolated environments: **DEV**, **STG**, **PT**, **QA**.

Each environment receives the full infrastructure stack:

| Component | Quantity | Technology | Specs |
|-----------|----------|------------|-------|
| NSX-T Firewall | 1 | NSX-T | Ports 443, 80 |
| Load Balancer | 1 | HAProxy | 1 CPU, configurable RAM |
| Reverse Proxy | 2 | Apache HTTPD 2.4 | 1 CPU, configurable RAM |
| App Server | 4 | Java/Dataframe | 1 CPU, configurable RAM/Disk |
| NFS Data Server | 1 | NFS | /mnt/data, encrypted, daily backup |
| NFS Binary Server | 1 | NFS | /mnt/binaries, encrypted, daily backup |

#### Remote State Files (Artifactory Backend)

All Terraform state is persisted in Artifactory with:
- Per-environment isolation
- State locking for concurrent access prevention
- Encrypted storage

---

## 3. Security Model

- All credentials flow through **Jenkins Credential Store backed by CyberArk**
- **NSX-T firewall** restricts ingress to ports 443 and 80 only
- **NFS storage** is encrypted at rest with daily backups
- **Manual approval gates** and ServiceNow change management before production changes
- **Terraform state files** stored securely in Artifactory with locking
- **Provider pinning** ensures consistent Terraform provider versions

---

## 4. Best Practices

### Terraform Agent Setup
1. Create VM from Marketplace image
2. Install Java (OpenJDK 17)
3. Install Terraform (pinned version)
4. Create jenkins user with SSH access
5. Configure SSH-based Jenkins agent
6. Label agent as `terraform-agent` for infra/terraform jobs

### On-Premise Terraform
- **Environment Isolation** — Separate state files per environment
- **Module Versioning** — Versioned modules in Artifactory registry
- **State Locking** — Artifactory backend with locking mechanism
- **Credentials in Jenkins Store** — CyberArk-backed, never in code
- **Provider Pinning** — Pin provider versions in required_providers
- **DRY Principle** — Reusable modules, shared library steps
- **Post-Deploy Ansible** — Configuration management after provisioning
- **Documentation** — Architecture docs, step-by-step guides, troubleshooting

---

## 5. Repository Structure

```
bnp-centralise-infra/
├── Jenkinsfile.template                    # Master pipeline template (6 stages)
├── sre_onboard_app.sh                      # Application onboarding automation
├── SRE_Ecosystem_Flow_Document.md          # Architecture documentation (this file)
├── SRE_Step_by_Step_Instructions.md        # Setup and usage guide
│
├── jenkins-shared-library/                 # Jenkins Shared Library
│   ├── vars/                               # Reusable pipeline steps
│   │   ├── terraformInit.groovy            # terraform init wrapper
│   │   ├── terraformValidate.groovy        # terraform validate wrapper
│   │   ├── terraformPlan.groovy            # terraform plan wrapper
│   │   ├── terraformApply.groovy           # terraform apply wrapper
│   │   ├── terraformDestroy.groovy         # terraform destroy wrapper
│   │   ├── cyberarkCredentials.groovy      # CyberArk credential helper
│   │   ├── approvalGate.groovy             # Approval + ServiceNow integration
│   │   ├── postDeployValidation.groovy     # Smoke tests, health checks, reports
│   │   └── artifactoryModuleFetch.groovy   # Artifactory module fetcher
│   ├── src/org/sre/ecosystem/              # Helper classes
│   │   └── TerraformHelper.groovy          # Terraform utility methods
│   └── resources/                          # Configuration resources
│       └── terraform-provider-mirror.tfrc  # Artifactory provider mirror config
│
├── terraform-modules/                      # Terraform Module Registry
│   └── modules/
│       ├── vsphere-vm/                     # Base VM module
│       │   ├── main.tf
│       │   ├── variables.tf
│       │   └── outputs.tf
│       ├── haproxy-lb/                     # HAProxy load balancer module
│       │   ├── main.tf
│       │   ├── variables.tf
│       │   └── outputs.tf
│       ├── nsx-firewall/                   # NSX-T firewall module
│       │   ├── main.tf
│       │   ├── variables.tf
│       │   └── outputs.tf
│       └── nfs-server/                     # NFS storage module
│           ├── main.tf
│           ├── variables.tf
│           └── outputs.tf
│
├── terraform-agent/                        # Terraform Agent Provisioning
│   └── setup-agent.sh                      # Agent setup script
│
└── sample-app-terraform/                   # Sample TF files for app teams
    ├── backend.tf                          # Artifactory backend config
    ├── variables.tf                        # Pipeline-injected variables
    ├── main.tf                             # Infrastructure using SRE modules
    ├── outputs.tf                          # Pipeline-captured outputs
    └── terraform.tfvars.example            # Example variable values
```

---

## 6. Files and Artifacts

| File | Purpose | Owner |
|------|---------|-------|
| `Jenkinsfile.template` | Master pipeline template with 6 stages | SRE |
| `sre_onboard_app.sh` | Onboarding automation script | SRE |
| `jenkins-shared-library/vars/*.groovy` | Reusable pipeline steps | SRE |
| `terraform-modules/modules/` | Versioned Terraform modules | SRE |
| `terraform-agent/setup-agent.sh` | Agent provisioning script | SRE |
| `sample-app-terraform/*.tf` | Sample Terraform scaffolding | SRE |
| `Jenkinsfile` (generated) | Application-specific pipeline | SRE (generated) |
| `*.tf` files (in app repo) | Terraform infrastructure definitions | Application Team |
| `tfplan-*.out` | Archived plan files per build | Pipeline (auto) |
| `tf-outputs-*.json` | Terraform output captures | Pipeline (auto) |
| `deployment-report-*.txt` | Post-deployment validation report | Pipeline (auto) |
